
namespace = rebellionscript

####Vulnerability (monthly trigger)


event = {
	id = rebellionscript.15
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		years_passed > 25
	}
	
	immediate = { #remove modifiers
		every_country = {
			if = {
				limit = {
					has_modifier = vulnerable_state_1
				}
				remove_modifier = vulnerable_state_1
			}
			if = {
				limit = {
					has_modifier = vulnerable_state_2
				}
				remove_modifier = vulnerable_state_2
			}
			every_owned_pop = { 
				if = {
					limit = {
						has_modifier = chance_to_force_change_1
					}
					remove_modifier = chance_to_force_change_1
				}
				if = {
					limit = {
						has_modifier = chance_to_force_change_2
					}
					remove_modifier = chance_to_force_change_2
				}
				if = {
					limit = {
						has_modifier = feel_vulnerable_1
					}
					remove_modifier = feel_vulnerable_1
				}
				if = {
					limit = {
						has_modifier = feel_vulnerable_2
					}
					remove_modifier = feel_vulnerable_2
				}
				if = {
					limit = {
						has_modifier = chance_to_revolt_1
					}
					remove_modifier = chance_to_revolt_1
				}
				if = {
					limit = {
						has_modifier = chance_to_revolt_2
					}
					remove_modifier = chance_to_revolt_2
				}
			}
			country_event = { id = rebellionscript.16 }	
		}
	}
}

country_event = {
	id = rebellionscript.16
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		NOT = { has_modifier = lost_war_vulnerable_state }
		is_subject = no
		
		any_owned_pop = { species = { pops_have_happiness = yes } }
		
		used_naval_capacity_percent < 0.9
				
		any_neighbor_country = {
			has_communications = root
			OR = {
				AND = {
					is_country_type = default
					OR = {
						is_hostile_to = root
						is_angry_to = root
						is_domineering_to = root
						is_rival = root
					}
				}
				is_country_type = awakened_fallen_empire
			}
			relative_power = {
				who = root
				category = fleet
				value = overwhelming
			}
		}
	}
	
			
	immediate = {
		random_neighbor_country = {
				limit = {
					has_communications = root
					OR = {
						AND = {
							is_country_type = default
							OR = {
								is_hostile_to = root
								is_angry_to = root
								is_domineering_to = root
								is_rival = root
							}
						}
						is_country_type = awakened_fallen_empire
					}
					relative_power = {
						who = root
						category = fleet
						value = overwhelming
					}
				}
				set_timed_country_flag = {
					flag = threat_state
					days = 5
				}
		}
		if = {
			limit = {
				NOT = { used_naval_capacity_percent < 0.5 }
				used_naval_capacity_percent < 0.9
			}
			add_modifier = {
				modifier = vulnerable_state_1
				days = -1
			}
			
			every_owned_pop = {
				if = {
					limit = {
						species = { pops_have_happiness = yes }
						OR = {
							AND = {
								is_same_species = root
								is_enslaved = no
							}
							AND = {
								NOT = { is_same_species = root }
								is_enslaved = no
								NOR = {
									has_ethic = ethic_xenophobe
									has_ethic = ethic_fanatic_xenophobe
								}
								root = {
									OR = {
										has_ethic = ethic_xenophile
										has_ethic = ethic_fanatic_xenophile
									}
								}
							}
						}
					}
					if = {
						limit = {
							species = { pops_have_happiness = yes }
							pop_opposite_ethic_to_empire = yes
						}
						add_modifier = {
							modifier = chance_to_force_change_1
							days = -1
						}		
						else = {
							add_modifier = { 
								modifier = feel_vulnerable_1
								days = -1
							}
						}
					}
				}
				if = {
					limit = {
						species = { pops_have_happiness = yes }
						OR = {
							NOT = { is_same_species = root }
							AND = {
								is_same_species = root
								is_enslaved = yes
							}
						}
						NOT = {
							AND = {
								NOT = { is_same_species = root }
								is_enslaved = no
								NOR = {
									has_ethic = ethic_xenophobe
									has_ethic = ethic_fanatic_xenophobe
								}
								root = {
									OR = {
										has_ethic = ethic_xenophile
										has_ethic = ethic_fanatic_xenophile
									}
								}
							}
						}
					}
					add_modifier = {
						modifier = chance_to_revolt_1
						days = -1
					}
				}
			}
		}
		if = {
			limit = {
				used_naval_capacity_percent < 0.5
			}

			add_modifier = {
				modifier = vulnerable_state_2
				days = -1
			}
			
			every_owned_pop = {
				if = {
					limit = {
						species = { pops_have_happiness = yes }
						OR = {
							AND = {
								is_same_species = root
								is_enslaved = no
							}
							AND = {
								NOT = { is_same_species = root }
								is_enslaved = no
								NOR = {
									has_ethic = ethic_xenophobe
									has_ethic = ethic_fanatic_xenophobe
								}
								root = {
									OR = {
										has_ethic = ethic_xenophile
										has_ethic = ethic_fanatic_xenophile
									}
								}
							}
						}
					}
					if = {
						limit = {
							species = { pops_have_happiness = yes }
							pop_opposite_ethic_to_empire = yes
						}
						add_modifier = {
							modifier = chance_to_force_change_2
							days = -1
						}		
						else = {
							add_modifier = { 
								modifier = feel_vulnerable_2
								days = -1
							}
						}
					}
				}
				if = {
					limit = {
						species = { pops_have_happiness = yes }
						OR = {
							NOT = { is_same_species = root }
							AND = {
								is_same_species = root
								is_enslaved = yes
							}
						}
						NOT = {
							AND = {
								NOT = { is_same_species = root }
								is_enslaved = no
								NOR = {
									has_ethic = ethic_xenophobe
									has_ethic = ethic_fanatic_xenophobe
								}
								root = {
									OR = {
										has_ethic = ethic_xenophile
										has_ethic = ethic_fanatic_xenophile
									}
								}
							}
						}
					}
					add_modifier = {
						modifier = chance_to_revolt_2
						days = -1
					}
				}
			}
		}
		if = {
			limit = {
				NOT = { has_country_flag = vulnerable }
			}
			country_event = { id = rebellionscript.19 }
		}
	}
}


# A war has been lost
# Root = Loser Warleader
# From = Winner Warleader
# FromFrom = War
country_event = {
	id = rebellionscript.17
	title = rebellionscript.17.name
	desc = {
		trigger = { NOT = { has_ethic = ethic_gestalt_consciousness } }
		text = rebellionscript.17.desc
	}
	desc = {
		trigger = { has_ethic = ethic_gestalt_consciousness }
		text = rebellionscript.17.desc.gestalt
	}
	picture = GFX_evt_fleet_evil
	is_triggered_only = yes
	
	trigger = {
		used_naval_capacity_percent < 0.15
		NOT = { any_owned_fleet = { fleet_size > 150 } }
		is_subject = no
		
		any_owned_pop = { species = { pops_have_happiness = yes } }
	}
	
	immediate = {
		country_event = { id = rebellionscript.171 days = 5 }

		add_modifier = {
			modifier = lost_war_vulnerable_state
			days = 720
		}	
		set_country_flag = vulnerable

		every_owned_pop = {
			limit = { species = { pops_have_happiness = yes } }
			if = {
				limit = {
					OR = {
						AND = {
							is_same_species = root
							is_enslaved = no
						}
						AND = {
							NOT = { is_same_species = root }
							is_enslaved = no
							NOR = {
								has_ethic = ethic_xenophobe
								has_ethic = ethic_fanatic_xenophobe
							}
							root = {
								OR = {
									has_ethic = ethic_xenophile
									has_ethic = ethic_fanatic_xenophile
								}
							}
						}
					}
				}
				if = {
					limit = { pop_opposite_ethic_to_empire = yes }
					add_modifier = {
						modifier = lost_war_chance_to_force_change
						days = 720
					}		
					else = {
						add_modifier = { 
							modifier = lost_war_feel_vulnerable
							days = 720
						}
					}
				}
			}
			if = {
				limit = {
					OR = {
						NOT = { is_same_species = root }
						AND = {
							is_same_species = root
							is_enslaved = yes
						}
					}
					NOT = {
						AND = {
							NOT = { is_same_species = root }
							is_enslaved = no
							NOR = {
								has_ethic = ethic_xenophobe
								has_ethic = ethic_fanatic_xenophobe
							}
							root = {
								OR = {
									has_ethic = ethic_xenophile
									has_ethic = ethic_fanatic_xenophile
								}
							}
						}
					}
				}
				add_modifier = {
					modifier = lost_war_chance_to_revolt
					days = 720
				}
			}
		}
	}
	option = {
		name = UNFORTUNATE
	}
}

country_event = {
	id = rebellionscript.171
	is_triggered_only = yes
	hide_window = yes
	
	trigger = { is_subject = yes }
	
	immediate = {
		if = {
			limit = { has_modifier = lost_war_vulnerable_state }
			remove_modifier = lost_war_vulnerable_state
		}
		if = {
			limit = { has_country_flag = vulnerable }
			remove_country_flag = vulnerable
		}
		every_owned_pop = {
			limit = { species = { pops_have_happiness = yes } }
			if = {
				limit = { has_modifier = lost_war_chance_to_force_change }
				remove_modifier = lost_war_chance_to_force_change
			}
			if = {
				limit = { has_modifier = lost_war_feel_vulnerable }
				remove_modifier = lost_war_feel_vulnerable
			}
			if = {
				limit = { has_modifier = lost_war_chance_to_revolt }
				remove_modifier = lost_war_chance_to_revolt
			}
		}
	}
}

country_event = {
	id = rebellionscript.19
	title = rebellionscript.16.name
	desc = {
		trigger = { NOT = { has_ethic = ethic_gestalt_consciousness } }
		text = rebellionscript.16.desc
	}
	desc = {
		trigger = { has_ethic = ethic_gestalt_consciousness }
		text = rebellionscript.16.desc.gestalt
	}
	picture = GFX_evt_alien_propaganda
	
	is_triggered_only = yes
	
	immediate = {
		set_country_flag = vulnerable
		
		#Needed for localisations
		random_neighbor_country = {
			limit = {
				has_communications = root
				has_country_flag = threat_state
#				OR = {
#					is_hostile_to = root
#					is_angry_to = root
#					is_domineering_to = root
#					is_rival = root
#				}
			}
			save_event_target_as = threat_state1
		}
	}

	option = {
		name = UNFORTUNATE
		
		tooltip = {
			if = {
				add_modifier = {
					modifier = vulnerable_state_1
					days = -1
				}
			}
			if = {
				limit = {
					used_naval_capacity_percent < 0.5
				}
				add_modifier = {
					modifier = vulnerable_state_2
					days = -1
				}
			}
		}
		custom_tooltip = cc_vulnerability_pops_tooltip
		custom_tooltip = cc_vulnerability_tooltip
	}
}

event = {
	id = rebellionscript.25
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		any_country = {
			has_country_flag = vulnerable
			NOR = {
				has_modifier = vulnerable_state_1
				has_modifier = vulnerable_state_2
				has_modifier = lost_war_vulnerable_state
			}
		}
	}
	immediate = {
		every_country = {
			limit = { 
				has_country_flag = vulnerable
				NOR = {
					has_modifier = vulnerable_state_1
					has_modifier = vulnerable_state_2
					has_modifier = lost_war_vulnerable_state
				}
			}
			remove_country_flag = vulnerable
			if = {
				limit = {
					is_ai = no
				}
				country_event = { id = rebellionscript.251 } #notify them
			}
		}
	}
}

country_event = {
	id = rebellionscript.251
	title = rebellionscript.25.name
	desc = {
		trigger = { NOT = { has_ethic = ethic_gestalt_consciousness } }
		text = rebellionscript.25.desc
	}
	desc = {
		trigger = { has_ethic = ethic_gestalt_consciousness }
		text = rebellionscript.25.desc.gestalt
	}
	picture = GFX_evt_fleet_good
	
	is_triggered_only = yes
	
	option = {
		name = rebellionscript.25.option
		
		custom_tooltip = cc_state_vulnerability_removed
	}
}
